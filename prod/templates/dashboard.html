<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Dashboard - GoEasyChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        /* Header and Navigation */
        header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            align-items: center;
            padding: 0 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: 70px;
        }

        .logo {
            margin-right: 40px;
        }

        .logo img {
            height: 40px;
        }

        .nav-container {
            display: flex;
            flex-grow: 1;
            justify-content: space-between;
        }

        .nav-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-links li {
            position: relative;
            margin: 0 5px;
        }

        .nav-links a {
            display: block;
            color: #333;
            text-decoration: none;
            padding: 10px 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #0084ff;
        }

        .nav-links a.active {
            color: #0084ff;
            border-bottom: 3px solid #0084ff;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 4px;
        }

        .dropdown-content a {
            padding: 12px 20px;
            display: block;
            color: #333;
            text-decoration: none;
            font-weight: normal;
        }

        .dropdown-content a:hover {
            background-color: #f5f5f5;
        }

        .nav-links li:hover .dropdown-content {
            display: block;
        }

        /* Main Content Area */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Page Content */
        .page-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 600px;
            padding: 20px;
        }

        .page-content.active {
            display: block;
        }

        /* Playground Header */
        .playground-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .playground-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 500;
            margin-right: 20px;
            display: flex;
            align-items: center;
        }

        .info-icon {
            margin-left: 8px;
            color: #666;
            cursor: pointer;
            font-size: 18px;
        }

        /* Bot Selector */
        .bot-dropdown {
            position: relative;
        }

        .bot-dropdown-button {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .bot-dropdown-button:after {
            content: 'â–¼';
            font-size: 12px;
            margin-left: 10px;
        }

        .bot-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 250px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10;
            border-radius: 4px;
            top: 100%;
            left: 0;
        }

        .bot-dropdown-content a {
            padding: 12px 20px;
            display: block;
            color: #333;
            text-decoration: none;
        }

        .bot-dropdown-content a:hover {
            background-color: #f5f5f5;
        }

        .bot-dropdown:hover .bot-dropdown-content {
            display: block;
        }

        /* Playground Content */
        .playground-container {
            width: 100%;
            height: 700px;
            background-color: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background-image: radial-gradient(circle, #e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Connect Page */
        .connect-container {
            padding: 30px;
        }

        .connect-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .code-box {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .code-box pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #0084ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .copy-btn:hover {
            background-color: #0073e6;
        }

        /* Placeholder Pages */
        .placeholder-content {
            padding: 40px;
            text-align: center;
            color: #666;
        }
        
        /* Custom chat styles for the playground */
        #customer-chatbot .daves-chat-window {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            width: 100% !important;
            height: 100% !important;
            max-height: 100% !important;
            border-radius: 8px !important;
            display: block !important;
        }
        
        #customer-chatbot .daves-chat-bubble {
            display: none !important;
        }
        
        /* Support chat bubble iframe container */
        #support-chat-container {
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 1000;
            width: 100px;
            height: 100px;
        }
        
        /* Hide the customer chatbot bubble */
        #playground-container .daves-chat-bubble {
            display: none !important;
        }
        
        #playground-container .daves-chat-window {
            display: flex !important;
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            width: 475px !important;  
            height: 475px !important; /* Fixed height for better proportions */
            max-height: 650px !important; /* Match fixed height */
            border-radius: 8px !important;
            margin: 0 auto !important; /* Center the chat window */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important; /* Add subtle shadow */
            background-color: white !important; /* Ensure white background */
        }

        /* Hide the user's chatbox closing "X" as it can't close so don't show it */
        #playground-container .daves-chat-window #daves-close-chat {
            display: none !important;
        }

        /* Add responsive behavior for mobile devices */
        @media (max-width: 768px) {
            #playground-container .daves-chat-window {
                width: 95% !important; /* Use more width on mobile */
                height: 600px !important; /* Slightly smaller height on mobile */
                max-height: 600px !important;
            }
        }

/* Sources Tab Styles */
.sources-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.sources-container h2 {
    margin-bottom: 5px;
}

.sources-container p {
    color: #666;
    margin-bottom: 20px;
}

.sources-stats-line {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.retrain-btn {
    margin-left: 15px;
    background-color: #1a1a1a;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.upload-box {
    border: 1px dashed #ccc;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    background-color: #f9f9f9;
    margin-bottom: 20px;
}

#dropzone {
    min-height: 150px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.file-types {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
}

.select-files-btn {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 4px;
    cursor: pointer;
}

#no-documents-message {
    text-align: center;
    padding: 30px 0;
}

#no-documents-message h4 {
    margin-bottom: 5px;
}

.document-card {
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.processing-indicator {
    background-color: #d1ecf1;
    color: #0c5460;
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.spinner {
    display: inline-block;
    width: 15px;
    height: 15px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: #0c5460;
    border-radius: 50%;
    animation: spin 1s infinite linear;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Custom Modal Styles */
.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1050;
    overflow: hidden;
    outline: 0;
}

.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}

.custom-modal-container {
    position: relative;
    z-index: 1060; /* Higher than the overlay */
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 20px;
}

.custom-modal-content {
    position: relative;
    background-color: #fff;
    border-radius: 6px;
    box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    pointer-events: auto;
    display: flex;
    flex-direction: column;
    outline: 0;
}

.custom-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 500;
}

.custom-modal-close {
    background: transparent;
    border: 0;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin: -15px -15px -15px auto;
    color: #999;
}

.custom-modal-close:hover {
    color: #333;
}

.custom-modal-body {
    padding: 20px;
}

.custom-modal-footer {
    display: flex;
    justify-content: flex-end;
    padding: 15px 20px;
    border-top: 1px solid #e9ecef;
}

.btn-cancel {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-cancel:hover {
    background-color: #5a6268;
}

.btn-delete:hover {
    background-color: #c82333;
}

    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/logo_120x40.png') }}" alt="GoEasyChat Logo">
            </div>
            <div class="nav-container">
                <ul class="nav-links">
                    <li><a href="javascript:void(0);" class="active" onclick="openPage('playground')">Playground</a></li>
                    <li><a href="javascript:void(0);" onclick="openPage('connect')">Connect</a></li>
                    <li><a href="javascript:void(0);" onclick="openPage('sources')">Sources</a></li>
                    <li><a href="javascript:void(0);" onclick="openPage('chat-logs')">Chat Logs</a></li>
                    <li><a href="javascript:void(0);" onclick="openPage('leads')">Leads</a></li>
                    <li>
                        <a href="javascript:void(0);" onclick="openPage('settings')">Settings</a>
                        <div class="dropdown-content">
                            <a href="javascript:void(0);">Profile</a>
                            <a href="javascript:void(0);">Billing</a>
                            <a href="javascript:void(0);">API Keys</a>
                            <a href="javascript:void(0);">Team</a>
                        </div>
                    </li>
                </ul>
                <ul class="nav-links">
                    <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Playground Page -->
        <div id="playground" class="page-content active">
            <div class="playground-header">
                <h1>
                    Playground
                    <span class="info-icon" title="Test and interact with your chatbot">â“˜</span>
                </h1>
                <div class="bot-dropdown">
                    <div class="bot-dropdown-button">
                        <span id="selected-bot-name">
                            {% if chatbots|length > 0 %}
                                {{ chatbots[0].company_url }}
                            {% else %}
                                No chatbots available
                            {% endif %}
                        </span>
                    </div>
                    <div class="bot-dropdown-content">
                        {% for chatbot in chatbots %}
                            <a href="javascript:void(0);" onclick="selectBot('{{ chatbot.chatbot_id }}', '{{ chatbot.company_url }}')">{{ chatbot.company_url }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div id="playground-container" class="playground-container">
                <!-- Customer's chatbot will be loaded here -->
                <div id="customer-chatbot"></div>
            </div>
        </div>

        <!-- Connect Page -->
        <div id="connect" class="page-content">
            <div class="connect-container">
                <h2>Embed Your Chatbot</h2>
                <p>Copy the code below and paste it into your website's HTML to embed your chatbot:</p>
                
                <div class="code-box">
                    <pre><code id="embed-code">
                &lt;script&gt;
                window.davesEasyChatConfig = {
                    chatbotId: "{% if chatbots|length > 0 %}{{ chatbots[0].chatbot_id }}{% else %}YOUR_CHATBOT_ID{% endif %}",
                    baseUrl: "{{ request.url_root.rstrip('/') }}"
                };
                &lt;/script&gt;
                &lt;script src="{{ request.url_root }}static/js/chatbot-embed.js" defer&gt;&lt;/script&gt;
                    </code></pre>
                    <button class="copy-btn" onclick="copyEmbedCode()">Copy</button>
                </div>
                
                <h3>Installation Instructions</h3>
                <p>1. Copy the code above by clicking the "Copy" button</p>
                <p>2. Paste the code into your website's HTML, just before the closing &lt;/body&gt; tag</p>
                <p>3. Save your changes and reload your website to see your chatbot in action</p>
            </div>
        </div>

        <!-- Sources Page -->
        <div id="sources" class="page-content">
            <div class="sources-container">
                <h2>Knowledge Sources</h2>
                <p>Upload documents to enhance your chatbot's knowledge</p>
                <!--
                <div class="sources-stats-line">
                    <span id="total-files">0</span> Files / <span id="total-size">0 KB</span> of <span id="max-size">33 MB</span>
                    <button id="retrain-agent-btn" class="retrain-btn">Retrain agent</button>
                </div>
                -->

                <div class="upload-box">
                    <div id="dropzone">
                        <p>Drag & drop files here, or click to select files</p>
                        <p class="file-types">Supported File Types: .pdf, .doc, .docx, .txt</p>
                        <button id="select-files-btn" class="select-files-btn">Select Files</button>
                        <input type="file" id="file-upload-input" accept=".pdf,.doc,.docx,.txt" style="display: none;">
                    </div>
                </div>

                <div id="document-processing" style="display: none;"></div>

                <div id="no-documents-message">
                    <h4>No documents found</h4>
                    <p>Upload documents using the area above</p>
                </div>
                
                <div id="documents-list">
                    <!-- Documents will be loaded here -->
                </div>
            </div>

            <!-- Document Preview Modal -->
            <div id="documentModal" class="custom-modal" style="display: none;">
                <div class="custom-modal-overlay"></div>
                <div class="custom-modal-container">
                    <div class="custom-modal-content">
                        <div class="custom-modal-header">
                            <h5 class="custom-modal-title" id="documentTitle">Document Content</h5>
                            <button type="button" class="custom-modal-close" onclick="closeDocumentModal()">&times;</button>
                        </div>
                        <div class="custom-modal-body">
                            <div id="documentContent" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="custom-modal-footer">
                            <button type="button" class="btn-cancel" onclick="closeDocumentModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteConfirmModal" class="custom-modal" style="display: none;">
                <div class="custom-modal-overlay"></div>
                <div class="custom-modal-container">
                    <div class="custom-modal-content">
                        <div class="custom-modal-header">
                            <h5 class="custom-modal-title">Confirm Delete</h5>
                            <button type="button" class="custom-modal-close" onclick="closeDeleteModal()">&times;</button>
                        </div>
                        <div class="custom-modal-body">
                            <p>Are you sure you want to delete this document?</p>
                            <p>This will permanently remove the document and all associated knowledge from your chatbot.</p>
                        </div>
                        <div class="custom-modal-footer">
                            <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                            <button type="button" class="btn-delete" id="confirmDeleteBtn">Delete Document</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Logs Page -->
        <div id="chat-logs" class="page-content">
            <div class="placeholder-content">
                <h2>Chat Logs</h2>
                <p>View your chatbot's conversation history here.</p>
            </div>
        </div>

        <!-- Leads Page -->
        <div id="leads" class="page-content">
            <div class="placeholder-content">
                <h2>Leads</h2>
                <p>Manage leads captured by your chatbot.</p>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page-content">
            <div class="placeholder-content">
                <h2>Settings</h2>
                <p>Configure your account and chatbot settings.</p>
            </div>
        </div>
    </main>

    <script>
        // Page navigation
        function openPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update active nav link
            const navLinks = document.querySelectorAll('.nav-links > li > a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                }
            });
            
            // If navigating to Sources tab, reload documents to apply the current chatbot filter
            if (pageId === 'sources') {
                loadDocuments();
            }
        }
        
        // Copy embed code
        function copyEmbedCode() {
            const embedCode = document.getElementById('embed-code').innerText;
            navigator.clipboard.writeText(embedCode).then(() => {
                alert('Embed code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy embed code. Please try again.');
            });
        }
        
        // Bot selection
        function selectBot(chatbotId, companyUrl) {
            document.getElementById('selected-bot-name').textContent = companyUrl;
            
            // Update embed code
            const embedCodeElement = document.getElementById('embed-code');
            if (embedCodeElement) {
                embedCodeElement.innerHTML = 
                    '&lt;script&gt;\n' +
                    'window.davesEasyChatConfig = {\n' +
                    '    chatbotId: "' + chatbotId + '",\n' +
                    '    baseUrl: "' + window.location.origin + '"\n' +
                    '};\n' +
                    '&lt;/script&gt;\n' +
                    '&lt;script src="' + window.location.origin + '/static/js/chatbot-embed.js" defer&gt;&lt;/script&gt;';
            }
            
            // Load the selected chatbot
            loadCustomerChatbot(chatbotId);
            
            // If the Sources tab is currently active, refresh its documents
            if (document.getElementById('sources').classList.contains('active')) {
                loadDocuments();
            }
        }
        
        // Load the customer's chatbot in the playground
        function loadCustomerChatbot(chatbotId) {
            // Remove any existing chatbot script and config
            const existingScripts = document.querySelectorAll('.customer-bot-script');
            existingScripts.forEach(script => script.remove());
            
            // Clear the container
            const container = document.getElementById('customer-chatbot');
            container.innerHTML = '';
            
            // Create a script to initialize the chatbot with custom config
            var chatbotConfig = document.createElement('script');
            chatbotConfig.className = 'customer-bot-script';
            chatbotConfig.innerHTML = 'window.davesEasyChatConfig = { chatbotId: "' + chatbotId + '", mountTo: "#customer-chatbot", readyToLoad: true };';
            document.head.appendChild(chatbotConfig);
            
            // Create a script to load the chatbot JavaScript
            var chatbotScript = document.createElement('script');
            chatbotScript.className = 'customer-bot-script'; 
            chatbotScript.src = "{{ url_for('static', filename='js/chatbot-embed.js') }}";
            document.body.appendChild(chatbotScript);
            
            // After the script loads, apply our own CSS to hide bubble and show window
            chatbotScript.onload = function() {
                // Wait a moment for the chatbot to initialize
                setTimeout(function() {
                    // Force the chat window to be visible and the bubble to be hidden
                    const chatBubble = document.querySelector('#customer-chatbot .daves-chat-bubble');
                    const chatWindow = document.querySelector('#customer-chatbot .daves-chat-window');
                    
                    if (chatBubble) {
                        chatBubble.style.display = 'none';
                    }
                    
                    if (chatWindow) {
                        chatWindow.classList.remove('d-none');
                        chatWindow.style.display = 'flex';
                        chatWindow.style.position = 'relative';
                        chatWindow.style.bottom = 'auto';
                        chatWindow.style.right = 'auto';
                        chatWindow.style.width = '100%';
                        chatWindow.style.height = '100%';
                        chatWindow.style.maxHeight = '700px';
                        chatWindow.style.borderRadius = '8px';
                        
                        // Add the welcome message if it doesn't exist
                        setTimeout(function() {
                            const messagesContainer = chatWindow.querySelector('#daves-chat-messages');
                            if (messagesContainer && messagesContainer.childNodes.length === 0) {
                                // Create and add the welcome message
                                const welcomeMsg = document.createElement('div');
                                welcomeMsg.className = 'daves-chat-message assistant';
                                welcomeMsg.innerHTML = 'Hi there! ðŸ‘‹ How can I help you?';
                                messagesContainer.appendChild(welcomeMsg);
                            }
                        }, 300);
                    }
                }, 100);
            };
        }
        
        // Support chatbot setup
        function setupSupportChatbot() {
            // Create a script element for GoEasyChat support bot
            var supportScript = document.createElement('script');
            supportScript.innerHTML = `
                window.davesEasyChatConfig = {
                    chatbotId: "8d3df74ea51443d898fe"
                };
            `;
            document.head.appendChild(supportScript);
            
            // Load the chatbot script
            var chatbotScript = document.createElement('script');
            chatbotScript.src = "{{ url_for('static', filename='js/chatbot-embed.js') }}";
            document.body.appendChild(chatbotScript);
        }
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load the first chatbot by default
            {% if chatbots|length > 0 %}
                loadCustomerChatbot('{{ chatbots[0].chatbot_id }}');
            {% endif %}
            
            // Setup the GoEasyChat support chatbot (commented out for now)
            // Uncomment the line below to enable the support chatbot
            // setupSupportChatbot();
        });
    </script>

<script>

// Custom Modal Functions
function showDeleteModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent body scrolling
    }
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore body scrolling
    }
}

function showDocumentModal() {
    const modal = document.getElementById('documentModal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent body scrolling
    }
}

function closeDocumentModal() {
    const modal = document.getElementById('documentModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore body scrolling
    }
}


// Sources Tab JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the Sources tab
    const sourcesTab = document.getElementById('sources');
    if (!sourcesTab) return;
    
    // Document tracking variables
    let activeDocId = null;
    let activeChatbotId = null;
    
    // File upload elements
    const fileInput = document.getElementById('file-upload-input');
    const selectFilesBtn = document.getElementById('select-files-btn');
    const dropzone = document.getElementById('dropzone');
    const uploadBox = document.querySelector('.upload-box');
    
    // Initialize the file upload button
    if (selectFilesBtn && fileInput) {
        selectFilesBtn.addEventListener('click', function() {
            fileInput.click();
        });
    }
    
    // File input change handler
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length > 0) {
                uploadFiles(fileInput.files);
            }
        });
    }
    
    // Drag and drop handlers
    if (uploadBox) {
        uploadBox.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#0d6efd';
            this.style.backgroundColor = '#f0f8ff';
        });
        
        uploadBox.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#ccc';
            this.style.backgroundColor = '#f9f9f9';
        });
        
        uploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#ccc';
            this.style.backgroundColor = '#f9f9f9';
            
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                uploadFiles(e.dataTransfer.files);
            }
        });
    }
    
    // Retrain agent button
    const retrainBtn = document.getElementById('retrain-agent-btn');
    if (retrainBtn) {
        retrainBtn.addEventListener('click', function() {
            retrainAgent();
        });
    }
    
    // Delete confirmation button
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            if (activeDocId && activeChatbotId) {
                deleteDocument(activeDocId, activeChatbotId);
                closeDeleteModal();
            }
        });
    }
    
    // Load documents when the tab is shown
    loadDocumentsWhenVisible();
    
    // Add listener for tab navigation
    document.addEventListener('click', function(e) {
        const sourcesTabLink = document.querySelector('a[onclick="openPage(\'sources\')"]');
        if (e.target === sourcesTabLink || (sourcesTabLink && sourcesTabLink.contains(e.target))) {
            loadDocumentsWhenVisible();
        }
    });
    
    // Function to load documents when tab becomes visible
    function loadDocumentsWhenVisible() {
        if (sourcesTab.classList.contains('active')) {
            loadDocuments();
        }
    }
    
    // Main function to load documents
    function loadDocuments() {
        const documentsList = document.getElementById('documents-list');
        const noDocumentsMessage = document.getElementById('no-documents-message');
        
        if (!documentsList) return;
        
        // Get the currently selected chatbot ID
        const selectedBotName = document.getElementById('selected-bot-name');
        let activeChatbotId = '';
        
        if (selectedBotName) {
            const chatbotOptions = document.querySelectorAll('.bot-dropdown-content a');
            for (let option of chatbotOptions) {
                if (option.textContent.trim() === selectedBotName.textContent.trim()) {
                    const match = option.getAttribute('onclick').match(/selectBot\('([^']+)'/);
                    if (match && match[1]) {
                        activeChatbotId = match[1];
                        break;
                    }
                }
            }
        }
        
        // Show loading state
        documentsList.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <div class="spinner" style="width: 30px; height: 30px;"></div>
                <p>Loading your documents...</p>
            </div>
        `;
        
        // Fetch documents from the server
        fetch('/documents/user-documents')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Filter documents to only show those for the active chatbot
                let filteredDocuments = data.documents || [];
                if (activeChatbotId) {
                    filteredDocuments = filteredDocuments.filter(doc => doc.chatbot_id === activeChatbotId);
                }
                
                // Update document stats
                updateDocumentStats(filteredDocuments);
                
                // Clear the container
                documentsList.innerHTML = '';
                
                if (filteredDocuments.length > 0) {
                    // Hide the "no documents" message
                    if (noDocumentsMessage) {
                        noDocumentsMessage.style.display = 'none';
                    }
                    
                    // Add each document to the list
                    filteredDocuments.forEach(doc => {
                        documentsList.appendChild(createDocumentElement(doc));
                    });
                } else {
                    // Show the "no documents" message
                    if (noDocumentsMessage) {
                        noDocumentsMessage.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                documentsList.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <p style="color: red;">Error loading documents. Please try again.</p>
                    </div>
                `;
            });
    }
    
// Create a document element with debug console logs
function createDocumentElement(doc) {
    const elem = document.createElement('div');
    elem.className = 'document-card';
    
    // Format the date
    const createdDate = new Date(doc.created_at);
    const formattedDate = createdDate.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
    });
    
    elem.innerHTML = `
        <div style="padding: 15px; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between;">
                <h5 style="margin: 0;">${doc.doc_name}</h5>
                <span style="background: #e7f3ff; color: #0d6efd; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                    ${doc.doc_type === 'scraped_content' ? 'Website Content' : 'Uploaded Document'}
                </span>
            </div>
        </div>
        <div style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #666; font-size: 14px;">
                <span>Added: ${formattedDate}</span>
                <span>Vectors: ${doc.vectors_count || 0}</span>
            </div>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 13px; max-height: 100px; overflow: hidden;">
                ${doc.content ? doc.content.substring(0, 300) + (doc.content.length > 300 ? '...' : '') : 'No preview available'}
            </div>
        </div>
        <div style="padding: 10px 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
            <button class="view-doc-btn" style="background: #0d6efd; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                View Content
            </button>
            <button class="delete-doc-btn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                Delete
            </button>
        </div>
    `;
    
    // Add event listeners to buttons
    const viewBtn = elem.querySelector('.view-doc-btn');
    const deleteBtn = elem.querySelector('.delete-doc-btn');
    
    if (viewBtn) {
        viewBtn.addEventListener('click', function() {
            console.log("View button clicked for doc:", doc.doc_id);
            viewDocument(doc.doc_id);
        });
    }
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
            console.log("Delete button clicked for doc:", doc.doc_id);
            e.preventDefault();
            e.stopPropagation();
            
            // Set the active document for deletion
            activeDocId = doc.doc_id;
            activeChatbotId = doc.chatbot_id;
            
            // Show our custom modal
            showDeleteModal();
        });
    }
    
    return elem;
}
    
    // Update document stats
    function updateDocumentStats(documents) {
        const totalFilesEl = document.getElementById('total-files');
        const totalSizeEl = document.getElementById('total-size');
        
        if (!totalFilesEl || !totalSizeEl) return;
        
        const count = documents.length;
        totalFilesEl.textContent = count;
        
        if (count > 0) {
            // Calculate total size (rough estimate)
            let totalSize = 0;
            documents.forEach(doc => {
                totalSize += doc.content ? doc.content.length : 0;
            });
            
            // Format size
            if (totalSize > 1024 * 1024) {
                totalSizeEl.textContent = Math.round(totalSize / (1024 * 1024) * 10) / 10 + ' MB';
            } else {
                totalSizeEl.textContent = Math.round(totalSize / 1024) + ' KB';
            }
        } else {
            totalSizeEl.textContent = '0 KB';
        }
    }
    
// Upload files
function uploadFiles(files) {
    if (!files || files.length === 0) return;
    
    // Get the current chatbot ID
    const selectedBotName = document.getElementById('selected-bot-name');
    let chatbotId = '';
    
    if (selectedBotName) {
        const chatbotOptions = document.querySelectorAll('.bot-dropdown-content a');
        for (let option of chatbotOptions) {
            if (option.textContent.trim() === selectedBotName.textContent.trim()) {
                const match = option.getAttribute('onclick').match(/selectBot\('([^']+)'/);
                if (match && match[1]) {
                    chatbotId = match[1];
                    break;
                }
            }
        }
        
        if (!chatbotId && chatbotOptions.length > 0) {
            // Try to get the first chatbot ID as fallback
            const match = chatbotOptions[0].getAttribute('onclick').match(/selectBot\('([^']+)'/);
            if (match && match[1]) {
                chatbotId = match[1];
            }
        }
    }
    
    if (!chatbotId) {
        alert('Error: No chatbot selected for this document.');
        return;
    }
    
    // Hide the dropzone and show the processing indicator with upload progress
    const uploadBox = document.querySelector('.upload-box');
    if (uploadBox) uploadBox.style.display = 'none';
    
    // Get the processing element and show it with upload progress UI
    const processingEl = document.getElementById('document-processing');
    if (processingEl) {
        processingEl.innerHTML = `
            <div class="processing-indicator">
                <div style="text-align: center;">
                    <div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"></div>
                    <div id="upload-status">
                        <strong>Uploading ${files[0].name}...</strong>
                    </div>
                    <div style="height: 5px; background: #e9ecef; border-radius: 3px; margin: 15px auto; width: 200px;">
                        <div id="upload-progress" style="height: 100%; width: 0%; background: #0d6efd; border-radius: 3px;"></div>
                    </div>
                    <p id="upload-percent">0%</p>
                </div>
            </div>
        `;
        processingEl.style.display = 'block';
    }
    
    // Create FormData
    const formData = new FormData();
    formData.append('document', files[0]);
    formData.append('chatbot_id', chatbotId);
    
    // Create and send request
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            const progressBar = document.getElementById('upload-progress');
            const percentText = document.getElementById('upload-percent');
            if (progressBar) progressBar.style.width = percent + '%';
            if (percentText) percentText.textContent = percent + '%';
        }
    });
    
    // Handle completion
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    // Update the processing indicator to show upload complete and retraining
                    if (processingEl) {
                        processingEl.innerHTML = `
                            <div class="processing-indicator">
                                <div style="text-align: center;">
                                    <div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"></div>
                                    <div id="upload-status">
                                        <strong>Uploading ${files[0].name}...</strong>
                                        <span style="display: inline; color: green; margin-left: 8px;">âœ“</span>
                                    </div>
                                    <div id="retraining-status" style="margin-top: 15px;">
                                        <strong>Retraining your bot, please stand by...</strong>
                                        <p>This may take a minute.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Start polling for processing completion
                    checkDocumentProcessingImproved(response.doc_id, uploadBox, files[0].name);
                } else {
                    alert('Error: ' + (response.error || 'Upload failed'));
                    // Restore the original state
                    if (uploadBox) uploadBox.style.display = 'block';
                    if (processingEl) processingEl.style.display = 'none';
                }
            } catch (e) {
                alert('Error: Invalid server response');
                // Restore the original state
                if (uploadBox) uploadBox.style.display = 'block';
                if (processingEl) processingEl.style.display = 'none';
            }
        } else {
            alert('Error: Server returned status ' + xhr.status);
            // Restore the original state
            if (uploadBox) uploadBox.style.display = 'block';
            if (processingEl) processingEl.style.display = 'none';
        }
    };
    
    // Handle error
    xhr.onerror = function() {
        alert('Error: Network error during upload');
        // Restore the original state
        if (uploadBox) uploadBox.style.display = 'block';
        if (processingEl) processingEl.style.display = 'none';
    };
    
    // Send the request with CSRF token
    xhr.open('POST', '/documents/upload-document', true);
    
    // Add CSRF token header
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    xhr.setRequestHeader('X-CSRFToken', csrfToken);
    
    xhr.send(formData);
}

// Check document processing status with improved UI flow
function checkDocumentProcessingImproved(docId, uploadBoxEl, fileName, attempts = 0, startTime = Date.now()) {
    const processingEl = document.getElementById('document-processing');
    
    // Maximum number of attempts (5 minutes)
    const maxAttempts = 60;
    // Minimum display time for processing indicator (4 seconds)
    const minDisplayTime = 4000;
    // Success message display time (3 seconds)
    const successMessageTime = 3000;
    
    if (attempts >= maxAttempts) {
        if (processingEl) processingEl.style.display = 'none';
        if (uploadBoxEl) uploadBoxEl.style.display = 'block';
        alert('Error: Document processing timed out. Please check back later.');
        loadDocuments();
        return;
    }
    
    // Check status
    fetch(`/documents/processing-status/${docId}`)
        .then(response => response.json())
        .then(data => {
            if (data.completed) {
                // Processing complete - show the checkmark on retraining line first
                const retrainingStatusEl = processingEl.querySelector('#retraining-status');
                if (retrainingStatusEl) {
                    const strongEl = retrainingStatusEl.querySelector('strong');
                    if (strongEl && !strongEl.innerHTML.includes('âœ“')) {
                        strongEl.innerHTML = strongEl.innerHTML + ' <span style="display: inline; color: green; margin-left: 8px;">âœ“</span>';
                    }
                }
                
                // Calculate elapsed time since start
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                // Wait for minimum display time, then show success message
                setTimeout(() => {
                    if (processingEl) {
                        // Show success message
                        processingEl.innerHTML = `
                            <div class="processing-indicator">
                                <div style="text-align: center; padding: 20px;">
                                    <h3 style="margin-bottom: 10px; color: #0c5460;">Your Bot is Smarter and Ready!</h3>
                                    <p>Visit the Playground to test it!</p>
                                </div>
                            </div>
                        `;
                        
                        // Wait 3 seconds with success message, then restore original UI
                        setTimeout(() => {
                            if (processingEl) processingEl.style.display = 'none';
                            if (uploadBoxEl) uploadBoxEl.style.display = 'block';
                            loadDocuments();
                        }, successMessageTime);
                    }
                }, remainingTime);
            } else {
                // Still processing, check again after 5 seconds
                setTimeout(() => {
                    checkDocumentProcessingImproved(docId, uploadBoxEl, fileName, attempts + 1, startTime);
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error checking processing status:', error);
            // Continue polling even on error
            setTimeout(() => {
                checkDocumentProcessingImproved(docId, uploadBoxEl, fileName, attempts + 1, startTime);
            }, 5000);
        });
}


// Check document processing status (using dropzone version)
function checkDocumentProcessingWithDropzone(docId, dropzoneEl, attempts = 0, startTime = Date.now()) {
    // Maximum number of attempts (5 minutes)
    const maxAttempts = 60;
    // Minimum display time for processing indicator (4 seconds)
    const minDisplayTime = 4000;
    
    if (attempts >= maxAttempts) {
        // Restore the original dropzone on timeout
        const originalContent = dropzoneEl.getAttribute('data-original-content');
        if (originalContent) {
            dropzoneEl.innerHTML = originalContent;
            // Reattach event listener to the select files button
            const newSelectBtn = document.getElementById('select-files-btn');
            if (newSelectBtn) {
                newSelectBtn.addEventListener('click', function() {
                    fileInput.value = ''; // Clear the input
                    fileInput.click();
                });
            }
        }
        
        alert('Error: Document processing timed out. Please check back later.');
        loadDocuments();
        return;
    }
    
    // Check status
    fetch(`/documents/processing-status/${docId}`)
        .then(response => response.json())
        .then(data => {
            if (data.completed) {
                // Processing complete, but ensure minimum display time
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                if (remainingTime > 0) {
                    // Wait for the remaining time before restoring
                    setTimeout(() => {
                        // Restore the original dropzone
                        const originalContent = dropzoneEl.getAttribute('data-original-content');
                        if (originalContent) {
                            dropzoneEl.innerHTML = originalContent;
                            // Reattach event listener to the select files button
                            const newSelectBtn = document.getElementById('select-files-btn');
                            if (newSelectBtn) {
                                newSelectBtn.addEventListener('click', function() {
                                    fileInput.value = ''; // Clear the input
                                    fileInput.click();
                                });
                            }
                        }
                        loadDocuments();
                    }, remainingTime);
                } else {
                    // Minimum time already passed, restore immediately
                    // Restore the original dropzone
                    const originalContent = dropzoneEl.getAttribute('data-original-content');
                    if (originalContent) {
                        dropzoneEl.innerHTML = originalContent;
                        // Reattach event listener to the select files button
                        const newSelectBtn = document.getElementById('select-files-btn');
                        if (newSelectBtn) {
                            newSelectBtn.addEventListener('click', function() {
                                fileInput.value = ''; // Clear the input
                                fileInput.click();
                            });
                        }
                    }
                    loadDocuments();
                }
            } else {
                // Still processing, check again after 5 seconds
                setTimeout(() => {
                    checkDocumentProcessingWithDropzone(docId, dropzoneEl, attempts + 1, startTime);
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error checking processing status:', error);
            // Continue polling even on error
            setTimeout(() => {
                checkDocumentProcessingWithDropzone(docId, dropzoneEl, attempts + 1, startTime);
            }, 5000);
        });
}
    
    // View document
    function viewDocument(docId) {
        fetch(`/documents/document/${docId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(doc => {
                const titleEl = document.getElementById('documentTitle');
                const contentEl = document.getElementById('documentContent');
                
                if (titleEl) titleEl.textContent = doc.doc_name;
                if (contentEl) contentEl.textContent = doc.content || 'No content available';
                
                // Show document modal
                showDocumentModal();
            })
            .catch(error => {
                console.error('Error viewing document:', error);
                alert('Error loading document content. Please try again.');
            });
    }
    
    // Delete document
    function deleteDocument(docId, chatbotId) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/documents/document/${docId}`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ chatbot_id: chatbotId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                loadDocuments();
            } else {
                alert('Error deleting document: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting document:', error);
            alert('Error deleting document. Please try again.');
        });
    }
    
    // Retrain agent
    function retrainAgent() {
        const selectedBotName = document.getElementById('selected-bot-name');
        if (!selectedBotName) {
            alert('No chatbot selected for retraining.');
            return;
        }
        
        // Find the chatbot ID
        let chatbotId = '';
        const chatbotOptions = document.querySelectorAll('.bot-dropdown-content a');
        
        for (let option of chatbotOptions) {
            if (option.textContent.trim() === selectedBotName.textContent.trim()) {
                const match = option.getAttribute('onclick').match(/selectBot\('([^']+)'/);
                if (match && match[1]) {
                    chatbotId = match[1];
                    break;
                }
            }
        }
        
        if (!chatbotId) {
            alert('Error: Could not determine which chatbot to retrain.');
            return;
        }
        
        // Show loading state
        const originalBtnText = retrainBtn.textContent;
        retrainBtn.disabled = true;
        retrainBtn.innerHTML = '<span class="spinner" style="width: 12px; height: 12px; margin-right: 5px;"></span> Retraining...';
        
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Send retraining request
        fetch(`/documents/retrain-agent/${chatbotId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                alert('Agent retrained successfully');
            } else {
                alert('Error retraining agent: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error retraining agent:', error);
            alert('Error retraining agent. Please try again.');
        })
        .finally(() => {
            // Reset button state
            retrainBtn.disabled = false;
            retrainBtn.textContent = originalBtnText;
        });
    }

});
</script>

<script>
    window.davesEasyChatConfig = {
        chatbotId: "8d3df74ea51443d898fe",
        baseUrl: "https://goeasychat.com"
    };
    </script>
    <script src="https://goeasychat.com/static/js/chatbot-embed.js" defer></script>

    <script src="/static/js/csrf.js"></script>
</body>
</html>